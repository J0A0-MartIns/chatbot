<div class="page-container">
    <div class="page-content">
        <h2><i class="fas fa-question-circle"></i> Quero Ajuda</h2>
        <p class="subtitle">Selecione o assunto e descreva sua dúvida para que eu possa ajudar.</p>

        <form (ngSubmit)="enviarPergunta()">
            <!-- Menus de seleção para Tema e Subtema -->
            <label for="tema">Tema:</label>
            <select id="tema" [(ngModel)]="idTemaSelecionado" name="tema" (change)="onTemaChange()" required>
                <option [ngValue]="null" disabled>-- Selecione um tema --</option>
                <option *ngFor="let t of temasDisponiveis" [ngValue]="t.id_tema">{{ t.nome }}</option>
            </select>

            <label for="subtema">Subtema:</label>
            <select id="subtema" [(ngModel)]="idSubtemaSelecionado" name="subtema" required [disabled]="!idTemaSelecionado">
                <option [ngValue]="null" disabled>-- Selecione um subtema --</option>
                <option *ngFor="let st of subtemasDisponiveis" [ngValue]="st.id_subtema">{{ st.nome }}</option>
            </select>

            <!-- Campo para a pergunta do utilizador -->
            <label for="pergunta">Qual é a sua dúvida?</label>
            <textarea id="pergunta" [(ngModel)]="pergunta" name="pergunta" rows="4" placeholder="Ex: Como faço para emitir a segunda via de um boleto?" required></textarea>

            <button type="submit" [disabled]="isLoading || !idSubtemaSelecionado">
                <i class="fas fa-paper-plane"></i> {{ isLoading ? 'A procurar...' : 'Enviar Pergunta' }}
            </button>
        </form>

        <!-- Container de Resposta que muda de acordo com o estado da conversa -->
        <div *ngIf="respostaChat" class="resposta-container">
            <h3>Resposta:</h3>
            <p class="resposta-texto">{{ respostaChat }}</p>

            <!-- CENÁRIO 1: RESPOSTA FOI ENCONTRADA -->
            <div *ngIf="respostaEncontrada === true">
                <!-- Etapa 1: Avaliação inicial de útil/não útil -->
                <div *ngIf="etapaFeedback === 'inicio'" class="avaliacao">
                    <span>Esta resposta foi útil?</span>
                    <button (click)="avaliar(true)" class="btn-util">Sim</button>
                    <button (click)="avaliar(false)" class="btn-nao-util">Não</button>
                </div>
                <!-- Etapa 2: Formulário para o comentário de feedback negativo -->
                <div *ngIf="etapaFeedback === 'comentario'" class="feedback-negativo-form">
                    <label for="comentario">Por favor, diga-nos o que estava a procurar para que possamos melhorar:</label>
                    <textarea id="comentario" [(ngModel)]="feedbackComentario" name="comentario" rows="3"></textarea>
                    <button (click)="enviarFeedbackNegativo()">Enviar Feedback</button>
                </div>
            </div>

            <!-- CENÁRIO 2: RESPOSTA NÃO FOI ENCONTRADA -->
            <div *ngIf="respostaEncontrada === false && etapaFeedback === 'inicio'">
                <div class="avaliacao">
                    <button (click)="enviarComoSugestao()" class="btn-sugestao">Sim, registar a minha dúvida</button>
                </div>
            </div>

            <!-- Etapa Final: Mensagem de agradecimento após o feedback -->
            <p *ngIf="etapaFeedback === 'finalizado'" class="feedback-agradecimento">
                <strong>Obrigado pelo seu feedback!</strong>
            </p>
        </div>
    </div>
</div>
