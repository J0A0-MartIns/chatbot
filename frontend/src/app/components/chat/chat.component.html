<div class="page-container">
    <div class="page-content">
        <h2><i class="fas fa-question-circle"></i> Quero Ajuda</h2>
        <p class="subtitle">Selecione o assunto e descreva sua dúvida para que eu possa ajudar.</p>

        <!-- Formulário para enviar a pergunta -->
        <form (ngSubmit)="enviarPergunta()">
            <label for="tema">Tema:</label>
            <select id="tema" [(ngModel)]="idTemaSelecionado" name="tema" (change)="onTemaChange()" required>
                <option [ngValue]="null" disabled>-- Selecione um tema --</option>
                <option *ngFor="let t of temasDisponiveis" [ngValue]="t.id_tema">{{ t.nome }}</option>
            </select>

            <label for="subtema">Subtema:</label>
            <select id="subtema" [(ngModel)]="idSubtemaSelecionado" name="subtema" required [disabled]="!idTemaSelecionado">
                <option [ngValue]="null" disabled>-- Selecione um subtema --</option>
                <option *ngFor="let st of subtemasDisponiveis" [ngValue]="st.id_subtema">{{ st.nome }}</option>
            </select>

            <label for="pergunta">Qual é a sua dúvida?</label>
            <textarea id="pergunta" [(ngModel)]="pergunta" name="pergunta" rows="4" placeholder="Ex: Como faço para emitir a segunda via de um boleto?" required></textarea>

            <button type="submit" [disabled]="isLoading || !idSubtemaSelecionado">
                <i class="fas fa-paper-plane"></i> {{ isLoading ? 'A procurar...' : 'Enviar Pergunta' }}
            </button>
        </form>

        <!-- Container de Resposta que muda de acordo com o estado da conversa -->
        <div *ngIf="solucoesEncontradas.length > 0 || respostaGenerica" class="resposta-container">

            <!-- CENÁRIO 1: SOLUÇÕES FORAM ENCONTRADAS -->
            <div *ngIf="respostaEncontrada === true">
                <h3>Soluções Sugeridas:</h3>
                <!-- Loop para exibir cada solução como um card -->
                <div *ngFor="let solucao of solucoesEncontradas" class="solucao-card">
                    <h4>{{ solucao.titulo }}</h4>
                    <p>{{ solucao.conteudo.substring(0, 200) }}...</p>
                </div>

                <!-- O fluxo de feedback agora aparece abaixo da lista de soluções -->
                <div *ngIf="etapaFeedback === 'inicio'" class="avaliacao">
                    <span>Estas sugestões foram úteis?</span>
                    <button (click)="avaliar(true)" class="btn-util">Sim</button>
                    <button (click)="avaliar(false)" class="btn-nao-util">Não</button>
                </div>
                <!-- Formulário para o comentário de feedback negativo -->
                <div *ngIf="etapaFeedback === 'comentario'" class="feedback-negativo-form">
                    <label for="comentario">Por favor, diga-nos o que estava a procurar para que possamos melhorar:</label>
                    <textarea id="comentario" [(ngModel)]="feedbackComentario" name="comentario" rows="3"></textarea>
                    <button (click)="enviarFeedbackNegativo()">Enviar Feedback</button>
                </div>
            </div>

            <!-- CENÁRIO 2: NENHUMA SOLUÇÃO ENCONTRADA -->
            <div *ngIf="respostaEncontrada === false">
                <h3>Resposta:</h3>
                <p class="resposta-texto">{{ respostaGenerica }}</p>
                <div *ngIf="etapaFeedback === 'inicio'" class="avaliacao">
                    <button (click)="enviarComoSugestao()" class="btn-sugestao">Sim, registar a minha dúvida</button>
                </div>
            </div>

            <!-- Mensagem de agradecimento após o feedback -->
            <p *ngIf="etapaFeedback === 'finalizado'" class="feedback-agradecimento">
                <strong>Obrigado pelo seu feedback!</strong>
            </p>
        </div>
    </div>
</div>
